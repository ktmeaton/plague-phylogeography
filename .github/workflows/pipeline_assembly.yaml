name: Pipeline Assembly
#This is a workflow for testing assembly datasets only.

# Global workflow environment variables
env:
    PHYLO_NF_REV: "master"
    PHYLO_CONDA_ENV: "plague-phylogeography-0.1.4dev"

on:
  # Triggered on Push for any branch
  push:
    branches:
      - '*'
    # On change to workflow, pipeline
    paths:
      - '.github/workflows/pipeline_assembly.yaml'
      - 'main.nf'
      - 'nextflow.config'
      - 'environment.yaml'

  # Triggered on PR for all branches, pipeline
  pull_request:
    branches:
      - '*'
  # Also on a published release
  release:
    types: [published]

jobs:

  # Install the pipeline and dependencies
  pipeline:
    runs-on: ubuntu-latest
    steps:

      # 1. Install nextflow
      - name: install nextflow
        run: |
          wget -qO- get.nextflow.io | bash
          sudo mv nextflow /usr/local/bin/

      # 2. Setup conda
      - name: setup conda
        uses: goanpeca/setup-miniconda@v1
        with:
          auto-update-conda: true

      # 3a. Install ktmeaton/plague-phylogeography
      - name: install nf ktmeaton/plague-phylogeography
        shell: bash -l {0}
        run: |
          nextflow pull ktmeaton/plague-phylogeography
          nextflow pull ktmeaton/plague-phylogeography -r ${PHYLO_NF_REV}
          nextflow run ktmeaton/plague-phylogeography --version

      # 3b. Install ktmeaton/plague-phylogeography
      - name: install conda ktmeaton/plague-phylogeography
        shell: bash -l {0}
        run: |
          conda env create -f  ~/.nextflow/assets/ktmeaton/plague-phylogeography/environment.yaml
          conda activate ${PHYLO_CONDA_ENV}
          conda deactivate

      # 4a. Run Assembly Pipeline
      - name: assembly pipeline
        shell: bash -l {0}
        run: |
          conda info --envs
          conda activate ${PHYLO_CONDA_ENV}
          nextflow run ktmeaton/plague-phylogeography \
            --max_datasets_assembly 2 \
            --skip_sra_download \
            --skip_eager \
            --skip_outgroup_download \
            --outdir test

      - name: artifact sqlite-import
        uses: actions/upload-artifact@v2
        with:
          name: sqlite-import
          path: test/sqlite_import/

      - name: artifact snippy-pairwise
        uses: actions/upload-artifact@v2
        with:
          name: snippy-pairwise
          path: test/snippy_pairwise/output10X/

      - name: artifact iqtree
        uses: actions/upload-artifact@v2
        with:
          name: iqtree
          path: test/iqtree/

      - name: artifact multiqc
        uses: actions/upload-artifact@v2
        with:
          name: multiqc
          path: test/multiqc/multiqc_report.html

      - name: artifact trace
        uses: actions/upload-artifact@v2
        with:
          name: trace
          path: test/trace/
